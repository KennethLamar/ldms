# Set topdir to be builddir/rpm
# note this is intentionally ignored by rpmbuild. must use
# commandline syntax in makefile.am to get this effect.
#% define _topdir %(echo $PWD)/toss
# do not set unfascist build
#%-define _unpackaged_files_terminate_build 0
#%-define _missing_doc_files_terminate_build 0

%define ldms_all System Environment/Libraries

# Main package
Summary: OVIS LDMS Commands and Libraries
Name: ldms-all
Version: @VERSION@
Release: ovis1%{?dist}
License: GPLv2 or BSD
Group: %{ldms_all}
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
Source: %{name}-%{version}.tar.gz
Requires: rpm >= 4.8.0 ovis-libevent2 boost-devel genders
BuildRequires: doxygen openssl-devel libibverbs-devel librdmacm-devel gcc ovis-libevent2-devel glib2-devel libibmad-devel boost-devel genders
Url: http://ovis.ca.sandia.gov/

Prefix: /usr


%description
This package provides the LDMS commands and libraries, OVIS apis and transport libraries, and scalable object store libraries.
Configured with @ac_configure_args@.
* ldmsd: the LDMS daemon, which can run as sampler or aggregator (or both).
* ldms_ls: the tool to list metric information of an ldmsd.
* ldmsctl: the tool to control an ldmsd.


%prep
%setup -q

%build
echo bTMPPATH %{_tmppath}
rm -rf $RPM_BUILD_ROOT
echo bBUILDROOT $RPM_BUILD_ROOT
%configure @ac_configure_args@ --disable-sos
make

%install
echo TMPPATH %{_tmppath}
echo BUILDROOT $RPM_BUILD_ROOT
make DESTDIR=${RPM_BUILD_ROOT} install
# remove unpackaged files from the buildroot
rm -f $RPM_BUILD_ROOT%{_libdir}/*.la
rm -f $RPM_BUILD_ROOT%{_libdir}/ovis-ldms/lib*.la
rm $RPM_BUILD_ROOT%{_bindir}/test_*
rm $RPM_BUILD_ROOT%{_bindir}/ldms_ban.sh
mv $RPM_BUILD_ROOT%{_docdir}/ovis-ldms-*/* $RPM_BUILD_ROOT%{_docdir}/%{name}-%{version}/
mkdir $RPM_BUILD_ROOT%{_sysconfdir}
cp -r $RPM_BUILD_ROOT%{_docdir}/%{name}-%{version}/sample_init_scripts/genders/etc/init.d $RPM_BUILD_ROOT%{_sysconfdir}
cp -r $RPM_BUILD_ROOT%{_docdir}/%{name}-%{version}/sample_init_scripts/genders/etc/sysconfig $RPM_BUILD_ROOT%{_sysconfdir}

%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,root)
%{_libdir}/*
%{_bindir}/*
%{_sbindir}/*
%{_docdir}/%{name}-%{version}/COPYING
%{_docdir}/%{name}-%{version}/ChangeLog
%{_docdir}/%{name}-%{version}/AUTHORS 
#end core

# devel
%package devel
Summary: LDMS devel package
Group: %{ldms_grp}
Requires: ldms-all = @VERSION@
%description devel
This is a development package of Lightweight Distributed Metric System (LDMS).
Users who want to implement their own sampler or store must install this
package.

%files devel
%defattr(-,root,root)
%{_includedir}/*/*.h
#end devel

# initscripts
%package initscripts
Summary: LDMS initscripts for libgenders control of %{name}
Group: %{ldms_grp}
Requires: ldms-all = @VERSION@
%description initscripts
This is the libgenders based boot scripts for LDMS daemons.
Users must provide information via /etc/genders (or alternate file)
to make these scripts operate. They are required to fail out of the box.

%files initscripts
%defattr(-,root,root)
%{_sysconfdir}/*/*
#end initscripts
%package doc
Summary: Documentation files for %{name}
Group: %{ldms_all}
## Requires: %{name}-devel = %{version}-%{release}
%description doc
Doxygen files for ldms-all package.
%files doc
%defattr(-,root,root)
%{_mandir}/*/*
%{_datadir}/doc/%{name}-%{version}
%docdir %{_defaultdocdir}
%changelog
* Thu Jun 18 2015 Ben Allan <baallan@sandia.gov> 2.4.3-1
packaging of initscripts for ldmsd/ldms-aggd.
* Thu May 23 2015 Ben Allan <baallan@sandia.gov> 2.4.2-1
update to latest upstream.
* Thu Apr 23 2015 Ben Allan <baallan@sandia.gov> 2.4.1-1
packaging with sysclassib and procstatutil2 enabled.
* Wed Feb 18 2015 Ben Allan <baallan@sandia.gov> 2.4.0-1
packaging with separate libevent
* Mon Sep 15 2014 Ben Allan <baallan@sandia.gov> 2.2.0-1
all-in-one packaging w/libevent
